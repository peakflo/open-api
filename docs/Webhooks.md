# Webhooks

Peakflo sends messages to your webhook endpoint URI whenever there is an update to a payment. To receive these you must configure the URL and access token in your peakflo account.

# Limits


Limit type | Count | Description
---------|----------|---------
 Maximum requests per minute	 | 100 | Maximum number of requests made per account
 Maximum retries	 | 5 | Maximum number of retries for single request if the request doesnt get a success response
 Retry delay in minutes	 |  10 | Number of minutes pause between each retry

 # Request headers

 The Request sent will include the below headers (Peakflo will share the access token ahead)


Parameter | Type | Description
---------|----------|---------
 Content-Type	 | string | application/json
 x-callback-token | string | access token

 The body of the request includes the below fields


Parameter | Type | Description
---------|----------|---------
 eventId | string | Unique id for the webhook request
 eventType | string | Type of webhook
 eventCreatedAt | string | Payment event date time in ISO 8601 format
 payments | json | The payments data based on the type of webhook


Refer section below for data sent for various types of webhooks

# Types of webhook

- payment created
- payment updated
- payment deleted
- push / send reminder

#### Payment created

The PAYMENT_CREATED is triggered when there is a new payment created within peakflo. The externalId passed by peakflo here must be used when you are using peakflo api to update the same payment. The request body looks like this

```json
{
  "eventId" : "ca77d168-8fab-4d7d-a156-fdac4df43ef0",
  "eventType" : "PAYMENT_CREATED",
  "eventCreatedAt" : "2021-04-05T14:48:00.000Z",
  "payments" : [{
      "paymentId" : "639bac74aff54497ba804e6f1ea09929",
      "externalId" : "0a5f41fe-3c8f-4d24-82e6-90bde4068934",
      "customerRef": "123edaFgds2",
      "status" : "deposited"
      "totalAmount": 346,
      "remainingAmount": 0,
      "currency": "USD",
      "currencyRate": 0,
      "paymentFee": 0,
      "paymentCreatedAt": "2021-04-05T14:43:00.000Z",
      "paymentLines": [
        {
          "amount": 346,
          "type": "Invoice",
          "id": "028f532be69d4ca49ccb54a385bcd4e5",
          "currencyRate": 0
        }
      ]
      "reference": "PF02300020100",
      "note": "payment towards invoice for logistics"
  }]
}
```


#### Payment updated

The PAYMENT_UPDATED is triggered when an existing payment with same reference is updated. The request body looks like this

```json
{
  "eventId" : "45645666aff54497ba804e6f1ea09929",
  "eventType" : "PAYMENT_UPDATED",
  "eventCreatedAt" : "2021-04-05T14:48:00.000Z",
  "payments" : [{
      "paymentId" : "639bac74aff54497ba804e6f1ea09929",
      "externalId" : "63bf352f-4531-4967-92c2-e65c51f39e65",
      "customerRef": "123edaFgds2",
      "status" : "deposited"
      "totalAmount": 346,
      "remainingAmount": 0,
      "currency": "USD",
      "currencyRate": 0,
      "paymentFee": 0,
      "paymentCreatedAt": "2021-04-05T14:43:00.000Z",
      "paymentLines": [
        {
          "amount": 346,
          "type": "Invoice",
          "id": "028f532be69d4ca49ccb54a385bcd4e5",
          "currencyRate": 0
        }
      ]
      "reference": "PF02300020100",
      "note": "payment towards invoice for logistics"
  }]
}
```
#### Payment deleted

The PAYMENT_DELETED is triggered when an existing payment is deleted. The request body looks like this

```json
{
  "eventId" : "45645666aff54497ba804e6f1ea09929",
  "eventType" : "PAYMENT_DELETED",
  "eventCreatedAt" : "2021-04-05T14:48:00.000Z",
  "payments" : [{
      "paymentId" : "639bac74aff54497ba804e6f1ea09929",
      "externalId" : "63bf352f-4531-4967-92c2-e65c51f39e65",
      "customerRef": "123edaFgds2",
      "status" : "deposited"
      "totalAmount": 346,
      "remainingAmount": 0,
      "currency": "USD",
      "currencyRate": 0,
      "paymentFee": 0,
      "paymentCreatedAt": "2021-04-05T14:43:00.000Z",
      "paymentLines": [
        {
          "amount": 346,
          "type": "Invoice",
          "id": "028f532be69d4ca49ccb54a385bcd4e5",
          "currencyRate": 0
        }
      ]
      "reference": "PF02300020100",
      "note": "payment towards invoice for logistics"
  }]
}
```


Payments fields details

Property | type | description
---------|----------|---------
 paymentId | string | The payment Id
 externalId | string | The unique reference Id. Generated by peakflo if source of payment is peakflo.
 customerRef | string | The customer reference Id
 totalAmount | string | Total payment amount 
 remainingAmount | string | The remaining amount
 currency |string | Payment currency in ISO
 currencyRate | string | Payment currency rate compared to your base currency
paymentCreatedAt | ISO date time | Payment created date time
reference | string | Payment reference
note |string | Note, if any

Payment lines fields


Property | type | description
---------|----------|---------
 amount | string | invoice amount
 type | string | Invoice or Refund
 id | string | invoice Id
 currencyRate | string | The currency rate


#### Push reminder

The REMINDER_CREATED event is triggered when a reminder is sent (or pushed) to an external system. The request body (of reminder schema) is sent to the webhook URL configured for the tenant. Once the reminder is sent, the messageId can be used to track the status of the reminder.


```json
{
  "customerExternalId" : "45645666aff54497ba804e6f1ea09929",
  "messageId" : "45645666aff54497ba804e6f1ea09929",
  "payload": {
    "title": "Please check this reminder!",
    "description": "This reminder is a sample reminder",
    "portalUrl": "https://stage-portal.peakflo.co/?token=sampletoken"
  }
}
```

Property | type | description
---------|----------|---------
 customer-id | string | The ID of the customer associated with the reminder.
 message-id | string | The unique identifier for the reminder message.
 payload | object | The payload containing details of the reminder.


#### Bill update

The BILL_UPDATED event is triggered when an existing bill is updated. The request body looks like this


```json
{
  "billNumber": "BILL12345",
  "status": "paid",
  "billExternalId": "123456789",
  "paymentId": "PAY789",
  "vendorId": "VENDOR001",
  "vendorName": "ABC Vendor",
  "date": "2023-11-27T12:00:00Z",
  "dueDate": "2023-12-15T23:59:59Z",
  "scheduledDate": "2023-12-10T00:00:00Z",
  "attachments": [
    {
      "id": "attachment_id_1",
      "name": "Attachment 1",
      "contentType": "application/pdf",
      "fileSize": 1024,
      "base64": "Base64EncodedContent1"
    }
  ],
  "currency": "USD",
  "subTotal": 500,
  "totalTax": 50,
  "paymentAmount": 450,
  "totalAmount": 550,
  "notes": "This is a test bill",
  "billPaymentId": "BP789",
  "totalWHT": 20,
  "items": [
    {
      "itemId": "ITEM001",
      "name": "Product A",
      "unit": "unit",
      "description": "Description for Product A",
      "quantity": 2,
      "unitPrice": 150,
      "accountId": "ACC001",
      "wht": {
        "id": "WHT001",
        "referenceId": "REF001",
        "code": "WHT_CODE",
        "displayName": "Withholding Tax",
        "amount": 10
      },
      "taxes": [
        {
          "externalId": "TAX001",
          "name": "Sales Tax",
          "amount": 20,
          "priceIncludesTax": true,
          "amountType": "percentage",
          "perc": 5
        }
      ],
      "discounts": [
        {
          "externalId": "Discount101",
          "name": "New user discount",
          "amount": 20,
          "amountType": "percentage"
        }
      ],
      "totalTax": 20,
      "totalDiscount": 0,
      "total": 320
    }
  ],
  "receiptDate": "2023-11-28T00:00:00Z",
  "paymentMadeDate": "2023-12-05T12:30:00Z"
}
```

| Property       | Type    | Description                                                  |
|----------------|---------|--------------------------------------------------------------|
| billNumber     | string  | The unique identifier for the bill.                           |
| status         | string  | The status of the bill (e.g., paid, pending, overdue).        |
| billExternalId | string  | An external ID associated with the bill.                       |
| paymentId      | string  | The unique identifier for the payment related to the bill.     |
| vendorId       | string  | The ID of the vendor associated with the bill.                 |
| vendorName     | string  | The name of the vendor.                                       |
| date           | string  | The date the bill was generated.                              |
| dueDate        | string  | The due date for payment of the bill.                          |
| scheduledDate  | string  | The scheduled payment date.                                   |
| attachments    | array   | An array containing details of attachments related to the bill.|
| currency       | string  | The currency used for the bill.                                |
| subTotal       | number  | The subtotal amount of the bill.                              |
| totalTax       | number  | The total tax amount applied to the bill.                      |
| paymentAmount  | number  | The amount paid for the bill.                                  |
| totalAmount    | number  | The total amount including tax and other charges.              |
| notes          | string  | Additional notes or description about the bill.                |
| billPaymentId  | string  | The ID associated with the bill payment.                       |
| totalWHT       | number  | The total amount of withholding tax for the bill.              |
| items          | array   | An array containing details of items listed on the bill.       |
| receiptDate    | string  | The date when the bill receipt was generated.                  |
| paymentMadeDate| string  | The date when the payment for the bill was made.               |
| updatedAt      | string  | The date when the bill was update.                             |


#### Purchase order update

The PO_UPDATED event is triggered when an existing purchase is updated. The request body looks like this


```json
{
  "totalAmount": 1500,
  "POAmount": 2000,
  "totalWHT": 100,
  "paidAmount": 1200,
  "balanceAmount": 300,
  "currency": "USD",
  "issueDate": "2023-10-15",
  "dueDate": "2023-11-30",
  "notes": "This is a sample note for the transaction.",
  "deliveryInstructions": "Deliver to address XYZ.",
  "status": "pending",
  "totalTax": 250,
  "fxRate": 1.2,
  "convertedAmount": 1800,
  "attachments": [
    {
      "id": "attachment_1",
      "name": "Invoice_001.pdf",
      "contentType": "application/pdf",
      "fileSize": 1024,
      "base64": "Base64EncodedContent1"
    },
    {
      "id": "attachment_2",
      "name": "Receipt_001.pdf",
      "contentType": "application/pdf",
      "fileSize": 2048,
      "base64": "Base64EncodedContent2"
    }
  ],
  "items": [
    {
      "itemId": "item_001",
      "name": "Product A",
      "unit": "unit",
      "description": "Description for Product A",
      "quantity": 5,
      "unitPrice": 300,
      "accountId": "ACC001",
      "wht": {
        "id": "WHT001",
        "referenceId": "REF001",
        "code": "WHT_CODE",
        "displayName": "Withholding Tax",
        "amount": 50
      },
      "taxes": [
        {
          "externalId": "TAX001",
          "name": "Sales Tax",
          "amount": 200,
          "priceIncludesTax": true,
          "amountType": "percentage",
          "perc": 10
        }
      ],
      "discounts": [
        {
          "externalId": "Discount001",
          "name": "Volume Discount",
          "amount": 50,
          "amountType": "percentage"
        }
      ]
    },
    {
      "itemId": "item_002",
      "name": "Product B",
      "unit": "unit",
      "description": "Description for Product B",
      "quantity": 3,
      "unitPrice": 250,
      "accountId": "ACC002",
      "wht": {
        "id": "WHT002",
        "referenceId": "REF002",
        "code": "WHT_CODE",
        "displayName": "Withholding Tax",
        "amount": 30
      },
      "taxes": [
        {
          "externalId": "TAX002",
          "name": "VAT",
          "amount": 50,
          "priceIncludesTax": false,
          "amountType": "fixed",
          "perc": 0
        }
      ],
      "discounts": [
        {
          "externalId": "Discount002",
          "name": "New User Discount",
          "amount": 20,
          "amountType": "percentage"
        }
      ]
    }
  ],
  "PONumber": "PO123456",
  "PQNumber": "PQ789012",
  "vendorId": "VENDOR001",
  "receiptDate": "2023-11-05",
  "deliveryDate": "2023-11-20",
  "bills": ["BILL001", "BILL002"],
  "receiptNotes": ["Received partial payment.", "Customer requested additional items."],
  "balanceQuantity": 7
}
```

| Property             | Type    | Description                                                  |
|----------------------|---------|--------------------------------------------------------------|
| totalAmount          | number  | The total amount for the purchase order.                         |
| POAmount             | number  | The total purchase order amount.                              |
| totalWHT             | number  | The total withholding tax amount.                             |
| paidAmount           | number  | The amount already paid.                                      |
| balanceAmount        | number  | The remaining balance amount.                                 |
| currency             | string  | The currency used for the purchase order.                        |
| issueDate            | string  | The date when the purchase order was issued.                     |
| dueDate              | string  | The due date for the purchase order.                              |
| notes                | string  | Additional notes or details about the purchase order.             |
| deliveryInstructions | string  | Specific instructions for delivery.                            |
| status               | string  | The current status of the purchase order.                         |
| totalTax             | number  | The total tax amount applied.                                 |
| fxRate               | number  | The foreign exchange rate applied.                            |
| convertedAmount      | number  | The amount after currency conversion.                         |
| attachments          | array   | An array containing details of attachments for the purchase order.|
| items                | array   | An array containing details of line items in the purchase order|
| PONumber             | string  | The purchase order number.                                    |
| PQNumber             | string  | The purchase quotation number.                                |
| vendorId             | string  | The ID of the vendor associated with the purchase order.          |
| receiptDate          | string  | The date when the receipt was generated.                      |
| deliveryDate         | string  | The expected delivery date.                                   |
| bills                | array   | An array containing IDs of bills.             |
| receiptNotes         | array   | An array containing receipt notes id.                  |
| balanceQuantity      | number  | The remaining quantity in stock.                              |

